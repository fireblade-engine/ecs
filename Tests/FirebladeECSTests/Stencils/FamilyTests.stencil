import FirebladeECS
import Testing
import Foundation

{% for idx in 1...8 %}
{% map 1...idx into components using index %}Comp{{ index }}{% endmap %}
{% set CompParams %}{{components|join: ", "}}{% endset %}
{% map components into compWhere using comp %}{{ comp }}: Component{% endmap %}
{% set CompsWhere %}{{compWhere|join: ", "}}{% endset %}
{% map components into compEncodable using comp %}{{ comp }}: Encodable{% endmap %}
{% set CompsWhereEncodable %}{{compEncodable|join: ", "}}{% endset %}
{% map components into compsDecodable using comp %}{{ comp }}: Decodable{% endmap %}
{% set CompsWhereDecodable %}{{compsDecodable|join: ", "}}{% endset %}
{% map components into compTypes using comp %}{{ comp }}.Type{% endmap %}
{% set CompsTypes %}{{compTypes|join: ", "}}{% endset %}
{% map components into compSelf using comp %}{{ comp }}.self{% endmap %}
{% set CompsSelf %}{{compSelf|join: ", "}}{% endset %}
{% map components into compsLowercased using comp %}{{ comp|lowercase }}{% endmap %}
{% set CompsLowercased %}{{compsLowercased|join: ", "}}{% endset %}
{% map components into compsTuple using comp %}components.{{ maploop.counter }}{% endmap %}
{% set CompsTuple %}{{compsTuple|join: ", "}}{% endset %}
{% map components into compsParams using comp %}{% if not maploop.first %}_ {% endif %}{{ comp|lowercase }}: {{ comp }}.Type{% endmap %}
{% set CompsParams %}{{compsParams|join: ", "}}{% endset %}
{% map components into compsJsonInner using comp %}"{{ comp }}":{ "value" : {{ maploop.counter0 }} }{% endmap %}
{% map 0...2 into compsJson %}{ {{compsJsonInner|join: ","}} }{% endmap %}
// MARK: - Family {{ idx }} test case
@Suite struct Family{{ idx }}Tests {
    @Test func memberCreation() {
        let nexus = Nexus()
        let family = nexus.family({% if components.count == 1 %}requires{% else %}requiresAll{%endif%}: {{ CompsSelf }})
        #expect(family.isEmpty)
        let entity = family.createMember(with: (
            {% for comp in components %}{{ comp }}({{ forloop.counter0 }}){% if not forloop.last %}, {% endif %}{% endfor %}
        ))
        #expect(family.count == 1)
        #expect(entity.numComponents == {{ idx }})
        #expect(nexus.numFamilies == 1)
        #expect(nexus.numEntities == 1)
        #expect(nexus.numComponents == {{ idx }})
        {% for comp in components %}
        #expect(entity[\{{ comp }}.value] == {{ forloop.counter0 }})
        {% endfor %} 
    }

    @Test func memberCreationBuilder() {
        let nexus = Nexus()
        let family = nexus.family({% if components.count == 1 %}requires{% else %}requiresAll{%endif%}: {{ CompsSelf }})
        #expect(family.isEmpty)
        let entity = family.createMember {
            {% for comp in components %}
            {{ comp }}({{ forloop.counter0 }})
            {% endfor %}
        }
        #expect(family.count == 1)
        #expect(entity.numComponents == {{ idx }})
        #expect(nexus.numFamilies == 1)
        #expect(nexus.numEntities == 1)
        #expect(nexus.numComponents == {{ idx }})
        {% for comp in components %}
        #expect(entity[\{{ comp }}.value] == {{ forloop.counter0 }})
        {% endfor %} 
    }

    @Test func componentIteration() {
        let nexus = Nexus()
        let family = nexus.family({% if components.count == 1 %}requires{% else %}requiresAll{%endif%}: {{ CompsSelf }})
        #expect(family.isEmpty)
        for i in 0..<10_000 {
            family.createMember(with: (
                {% for comp in components %}{{ comp }}({{ forloop.counter0 }} * 1_000_000 + i){% if not forloop.last %}, {% endif %}{% endfor %}
            ))
        }
        #expect(family.count == 10_000)
        var idx: Int = 0
        family.forEach { ({{ CompsLowercased }}) in
            {% for comp in compsLowercased %}
            #expect({{ comp }}.value == {{ forloop.counter0 }} * 1_000_000 + idx)
            {% endfor %}
            idx += 1
        }
    }

    @Test func entityIteration() {
        let nexus = Nexus()
        let family = nexus.family({% if components.count == 1 %}requires{% else %}requiresAll{%endif%}: {{ CompsSelf }})
        #expect(family.isEmpty)
        for i in 0..<10_000 {
            family.createMember(with: (
                {% for comp in components %}{{ comp }}({{ forloop.counter0 }} * 1_000_000 + i){% if not forloop.last %}, {% endif %}{% endfor %}
            ))
        }
        #expect(family.count == 10_000)
        var idx: Int = 0
        family.entities.forEach { (entity) in
            #expect(entity.numComponents == {{ idx }})
            {% for comp in components %}
            #expect(entity[\{{ comp }}.value] == {{ forloop.counter0 }} * 1_000_000 + idx)
            {% endfor %}
            idx += 1
        }
    }

    @Test func entityComponentIteration() {
        let nexus = Nexus()
        let family = nexus.family({% if components.count == 1 %}requires{% else %}requiresAll{%endif%}: {{ CompsSelf }})
        #expect(family.isEmpty)
        for i in 0..<10_000 {
            family.createMember(with: (
                {% for comp in components %}{{ comp }}({{ forloop.counter0 }} * 1_000_000 + i){% if not forloop.last %}, {% endif %}{% endfor %}
            ))
        }
        #expect(family.count == 10_000)
        var idx: Int = 0
        family.entityAndComponents.forEach { (entity, {{ CompsLowercased }}) in
            #expect(entity.numComponents == {{ idx }})
            {% for comp in components %}
            #expect({{ comp|lowercase }}.value == {{ forloop.counter0 }} * 1_000_000 + idx)
            #expect(entity[\{{ comp }}.self] == {{ comp|lowercase }})
            {% endfor %}
            idx += 1
        }
    }

    @Test func familyEncoding() throws {
        let nexus = Nexus()
        let family = nexus.family({% if components.count == 1 %}requires{% else %}requiresAll{%endif%}: {{ CompsSelf }})
        #expect(family.isEmpty)
        for i in 0..<100 {
            family.createMember(with: (
                {% for comp in components %}{{ comp }}({{ forloop.counter0 }} * 1_000_000 + i){% if not forloop.last %}, {% endif %}{% endfor %}
            ))
        }
        #expect(family.count == 100)

        var jsonEncoder = JSONEncoder()
        let encodedData = try family.encodeMembers(using: &jsonEncoder)
        #expect(encodedData.count > 10)
        guard let jsonString = String(data: encodedData, encoding: .utf8) else {
            Issue.record("Failed to read string from encoded data \(encodedData.count)")
            return
        }
        
        let expectedStart = "[{"
        #expect(String(jsonString.prefix(expectedStart.count)) == expectedStart)
        let expectedEnd = "}]"
        #expect(String(jsonString.suffix(expectedEnd.count)) == expectedEnd)
    }

    @Test func familyDecoding() throws {
        let nexus = Nexus()
        let jsonString: String = """
                                 [ 
                                   {% for i in 0...2 %}
                                   { {% for comp in components %}"{{ comp }}":{ "value" : {{ forloop.counter0 }} }{% if not forloop.last %},{% endif %}{% endfor %} }{% if not forloop.last %},{% endif %}
                                   {% endfor %}
                                 ]
                                 """
        guard let jsonData = jsonString.data(using: .utf8) else {
            Issue.record("Failed to read data from json string \(jsonString.count)")
            return
        }
        let family = nexus.family({% if components.count == 1 %}requires{% else %}requiresAll{%endif%}: {{ CompsSelf }})
        #expect(family.isEmpty)
        var jsonDecoder = JSONDecoder()
        let newEntities = try family.decodeMembers(from: jsonData, using: &jsonDecoder)
        #expect(newEntities.count == 3)
        #expect(family.count == 3)
    }

    @Test func familyFailDecoding() {
        let nexus = Nexus()
        let jsonString = """
                         [{ "SomeOtherComp": { "someValue": "fail" } }]
                         """
        guard let jsonData = jsonString.data(using: .utf8) else {
            Issue.record("Failed to read data from json string \(jsonString.count)")
            return
        }
        let family = nexus.family({% if components.count == 1 %}requires{% else %}requiresAll{%endif%}: {{ CompsSelf }})
        #expect(family.isEmpty)
        var jsonDecoder = JSONDecoder()
        #expect(throws: Error.self) {
            try family.decodeMembers(from: jsonData, using: &jsonDecoder)
        }
    }
}

{% endfor %}
// MARK: - Components
{% for idx in 1...8 %}
final class Comp{{ idx }}: Component, @unchecked Sendable {
    var value: Int
    init(_ value: Int) { self.value = value }
}
extension Comp{{ idx }}: Equatable {
    static func == (lhs: Comp{{ idx }}, rhs: Comp{{ idx }}) -> Bool {
        lhs === rhs && lhs.value == rhs.value
    }
}
extension Comp{{ idx }}: Codable { }

{% endfor %}